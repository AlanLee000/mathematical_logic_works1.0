# 形式系统 $\mathcal{L}^Q$：量化层级结构逻辑
**(Quantified Hierarchical Structural Logic)**

## 1. 语法 (Syntax)

### 1.1 符号集
*   **变量集 (Variables):** $\mathcal{X} = \{x, y, z, x_1, x_2, \dots\}$，可数无限集。
*   **原子常数集 (Atomic Constants):** $\mathcal{A} = \{a, b, c, \dots\}$。
*   **逻辑连接词:** $\cong$ (结构等价), $\leq$ (结构序), $\neg$ (否定)。
*   **量词:** $\forall$ (全称), $\exists$ (存在)。
*   **辅助符号:** $(, )$。

### 1.2 项与公式 (Terms and Formulas)
在 $\mathcal{L}^Q$ 中，由于真值与结构紧密耦合，我们不区分“项”与“公式”。所有合法的语法构造统称为**项 (Terms)**。集合 $\mathcal{T}$ 定义如下：

$$ t ::= x \mid c \mid t_1 \cong t_2 \mid t_1 \leq t_2 \mid \neg t \mid \forall x. t \mid \exists x. t $$

其中 $x \in \mathcal{X}, c \in \mathcal{A}$。

*   **自由变量 (Free Variables):** $FV(t)$ 表示项 $t$ 中未被量化的变量集合。
*   **封闭项 (Closed Terms):** 若 $FV(t) = \emptyset$，称 $t$ 为封闭项（或句子）。
*   **替换:** $t[u/x]$ 表示将 $t$ 中所有自由出现的 $x$ 替换为 $u$。

---

## 2. 语义模型 (Semantics)

### 2.1 语义值空间
为了赋予系统处理复杂非线性结构的能力，我们引入格论作为语义基础。

定义 **结构层级空间** 为一个**完备分配格 (Complete Distributive Lattice)** $\Lambda = \langle L, \sqsubseteq, \sqcup, \sqcap, \bot, \top \rangle$。
*   $L$: 结构层级值的集合。
*   $\sqsubseteq$: 偏序关系，表示结构强度的包含或层级顺序。
*   $\sqcup$ (Join): 上确界运算。
*   $\sqcap$ (Meet): 下确界运算。
*   $\bot, \top$: 分别为格的最小元和最大元。

定义 **扩展自然数集** $\overline{\mathbb{N}} = \mathbb{N} \cup \{+\infty\}$，运算遵循标准扩展算术。

定义 **值空间** $\mathcal{V} = \mathbb{N} \times L \times \overline{\mathbb{N}} \times \{0, 1\}$。
任意语义结构值 $\mathbf{v} = \langle i, \lambda, k, p \rangle \in \mathcal{V}$ 包含四个维度：
1.  **$i \in \mathbb{N}$ (标识符 Identity):**
    *   $i 0$: 表示具体的原子对象或常数。
    *   $i = 0$: **中性标识符 (Neutral Identity)**，表示量化后的聚合对象。
2.  **$\lambda \in L$ (结构格位 Structural Lattice Point):** 表示对象在逻辑结构中的位置。
3.  **$k \in \overline{\mathbb{N}}$ (构造索引 Constructive Index):** 表示结构的递归构造深度。
4.  **$p \in \{0, 1\}$ (极性 Polarity):** 0 为正 (Positive)，1 为负 (Negative)。

定义 **扩展真值** $\mathcal{T}_{val} = \{0, 1\}$。
模型解释结果为二元组 $\mathcal{E} = \mathcal{T}_{val} \times \mathcal{V}$。

### 2.2 模型结构
一个模型 $\mathfrak{M}$ 由三元组 $\langle \Lambda, \mathcal{D}, I \rangle$ 构成：
*   **$\Lambda$:** 背景结构格。
*   **$\mathcal{D}$:** 论域，$\mathcal{D} \subseteq \mathcal{E}$且 $D\neq \emptyset$。
*   **$I$:** 解释函数，将原子常数映射到论域元素，并指定其格位。
    对于每个常数 $c \in \mathcal{A}$，模型指定一个固定的格位值 $\lambda_c \in L$。

*   **赋值函数 (Assignment):** $g: \mathcal{X} \to \mathcal{D}$。

### 2.3 结构运算定义
定义作用于结构值 $\mathbf{v}$ 的辅助运算：

1.  **模后继相等 ($\approx$):**
    $\mathbf{v}_1 \approx \mathbf{v}_2 \iff i_1=i_2 \land \lambda_1=\lambda_2 \land p_1=p_2$。
    *(注：要求标识符、格位、极性严格全等，忽略构造索引 $k$)*

2.  **序关系判定 ($\preceq$):**
    $\mathbf{v}_1 \preceq \mathbf{v}_2$ 当且仅当满足以下三个条件：
    *   $p_1 = p_2$ (同极性)
    *   **结构序 (极性依赖):**
        *   若 $p_1 = 0$ (正极性)，则 $\lambda_1 \sqsubseteq \lambda_2$ (协变)。
        *   若 $p_1 = 1$ (负极性)，则 $\lambda_1 \sqsupseteq \lambda_2$ (逆变)。

3.  **单体提升 (lift):**
    $\text{lift}(\langle i, \lambda, k, p \rangle) = \langle i, \lambda, k+1, p \rangle$。

4.  **合并提升 (merge-lift):**
    $\text{merge-lift}(\mathbf{v}_1, \mathbf{v}_2) = \langle i_2, \lambda_2, \max(k_1, k_2)+1, p_2 \rangle$。
    *(注：结果继承右侧操作数 $\mathbf{v}_2$ 的格位 $\lambda$ 和极性 $p$)*

5.  **量化聚合 (quant-agg):**
    量词操作将消除个体标识，并在格上计算结构的上确界。
    设 $S \subseteq \mathcal{V}$ 是一组结构值。定义聚合函数：
    $$ \text{quant-agg}(S) = \langle 0, \; \bigsqcup_{\mathbf{v} \in S}(\lambda_{\mathbf{v}}), \; \sup_{\mathbf{v} \in S}(k_{\mathbf{v}}) + 1, \; 0 \rangle $$
    *   **$i$:** 强制归零 (0)。
    *   **$\lambda$:** 取集合中所有 $\lambda$ 值的格上确界 (Join)。由 $\Lambda$ 的完备性保证其存在。
    *   **$k$:** 取索引上确界加 1。
    *   **$p$:** 重置为 0 (正极性)。

### 2.4 解释函数 $⟦ \cdot ⟧$
给定模型 $\mathfrak{M}$ 和赋值 $g$，项 $t$ 的解释 $⟦ t ⟧_g = \langle \tau, \mathbf{v} \rangle$ 递归定义如下：

1.  **变量 ($x$):** $⟦ x ⟧_g = g(x)$。
2.  **常数 ($c$):** $I(c) = \langle 1, \langle \text{id}(c), I_\Lambda(c), 0, 0 \rangle \rangle$。
3.  **否定 ($\neg t$):**
    设 $⟦ t ⟧_g = \langle \tau, \langle i, \lambda, k, p \rangle \rangle$。
    $$ ⟦ \neg t ⟧_g = \langle 1-\tau, \langle i, \lambda, k, 1-p \rangle \rangle $$
4.  **结构等价 ($t_1 \cong t_2$):**
    设 $⟦ t_1 ⟧_g = \langle \tau_1, \mathbf{v}_1 \rangle, ⟦ t_2 ⟧_g = \langle \tau_2, \mathbf{v}_2 \rangle$。
    $$ ⟦ t_1 \cong t_2 ⟧_g = \begin{cases} \langle 1, \text{lift}(\mathbf{v}_1) \rangle & \text{若 } \tau_1=\tau_2 \land \mathbf{v}_1 \approx \mathbf{v}_2 \land k_1=k_2 \\ \langle 0, \langle 0, \bot, 0, 0 \rangle \rangle & \text{其他情况} \end{cases} $$
5.  **结构序 ($t_1 \leq t_2$):**
    $$ ⟦ t_1 \leq t_2 ⟧_g = \begin{cases} \langle 1, \text{merge-lift}(\mathbf{v}_1, \mathbf{v}_2) \rangle & \text{若 } \mathbf{v}_1 \preceq \mathbf{v}_2 \\ \langle 0, \langle 0, \bot, 0, 0 \rangle \rangle & \text{其他情况} \end{cases} $$
6.  **全称量词 ($\forall x. t$):**
    令 $D_t = \{ ⟦ t ⟧_{g[x \mapsto d]} \mid d \in \mathcal{D} \}$，且 $V_{set}$ 为其中结构值集合，$T_{set}$ 为真值集合。
    $$ ⟦ \forall x. t ⟧_g = \langle \min(T_{set}), \langle 0, \; \sqcap_{\mathbf{v} \in V_{set}}(\lambda_{\mathbf{v}}), \; \sup_{\mathbf{v} \in V_{set}}(k_{\mathbf{v}}) + 1, \; 0 \rangle \rangle $$
7.  **存在量词 ($\exists x. t$):**
    $$ ⟦ \exists x. t ⟧_g = \langle \max(T_{set}), \text{quant-agg}(V_{set}) \rangle $$


---

## 3. 推理系统 (Inference System)

记 $\Gamma \vdash t$ 表示在前提 $\Gamma$ 下，$t$ 是可证的（即真值为 1）。

### 3.1 核心结构逻辑 (Core Structural Logic)
保留原系统 $\mathcal{L}$ 的所有规则。这些规则处理具体的结构交互。


我们用 $\vdash t$ 表示项 $t$ 在系统 $\mathcal{L}$ 中是可证的。$\Gamma \vdash t$表示在前提集$\Gamma$下是可证的。

### 模块 A: 等价性质
*   **Refl:** $$\frac{}{t_{1} \cong t_{1} }$$
*   **Symm:** $$\frac{t_{1} \cong t_{2}}{t_{2}\cong t_{1} }$$
*   **Trans:** $$\frac{t_{1} \cong t_{2}, \quad t_{2}\cong t_{3}}{t_{1} \cong t_{3}}$$

### 模块 B: 预序与同余引入
*   **Id-Intro:** $$\frac{}{t_{1} \leq t_{1} }$$
*   **Transitivity:**$$\frac{t_{1}\leq t_{2},\quad t_{2}\leq t_{3}}{t_{1}\leq t_{3}}$$
*   **Cumulativity:** $$\frac{t_1 \leq t_2}{t_2 \leq (t_1 \leq t_2)}$$

*   **Rule B1:** $$\frac{t_{1} \leq t_{2}, \quad t_{2}\cong t_{3}}{t_{1} \leq (t_{2}\cong t_{3})}$$
*   **Rule B2:** $$\frac{t_{1} \leq t_{2}, \quad t_{1} \cong t_{3}}{(t_{1} \cong t_{3}) \leq t_{2}}$$
*   **Rule B3:** $$\frac{(t_{1} \cong t_{2}) \leq t_{3},\quad t_{1} \cong t_{2},\quad t_{2}\cong t_{4}}{(t_{2}\cong t_{4}) \leq t_{3}}$$
*   **Rule B4:** $$\frac{t_{1} \leq (t_{2} \cong t_{3}), \quad t_{2} \cong t_{3},\quad t_{3}\cong t_{4}}{t_{1} \leq (t_{3} \cong t_{4})}$$

### 模块 C: 构造同余
*   **Rule C1:** $$\frac{t_{1} \cong t_{2}, \quad t_{3} \cong t_{4}}{(t_{1} \leq t_{3}) \cong (t_{2}\leq t_{4})}$$
*   **Rule C2:** $$\frac{t_{1} \cong t_{2}}{\neg t_{1} \cong \neg t_{2}}$$
*   **Rule C3:** $$ \frac{t_1 \cong t_2}{\forall x. t_1 \cong \forall x. t_2} $$

### 模块 D: 否定逻辑

*   **Rule D0:** $$ \frac{\neg t_2 \leq \neg t_1}{t_1 \leq t_2} $$
*   **Rule D1:** $$\frac{t_{1} \leq t_{2}}{\neg t_{2}\leq \neg t_{1} }$$
*   **Rule D2:** $$\frac{}{ t_{1} \leq \neg \neg t_{1} }$$
*   **Rule D3:** $$\frac{}{\neg ( t_{1} \cong \neg t_{1})}$$
*   **Rule D5:** $$\frac{}{\neg \neg t_{1} \cong t_{1} }$$
*   **Rule D6:** $$\frac{t_{1}, \quad \neg t_{1}}{ t_{2}}$$

### 模块 E: 替换规则
*   **Rule E1:** $$\frac{t_{1} \cong t_{2}, \quad t_{1} \leq t_{3}}{t_{2}\leq t_{3}}$$
*   **Rule E2:** $$\frac {t_{3} \leq t_{1}, \quad t_{1}\cong t_{2}} {t_{3} \leq t_{2}}$$
*   **Rule E3:** $$\frac{t_{1} \cong t_{2}, \quad \neg t_{1} }{\neg t_{2}}$$
*   **Rule E4:** $$\frac{t_{1}, \quad t_{1} \cong t_{2}}{t_{2}}$$
---

### 模块 F: 层级规则

*   **Rule F1:** $$ \frac{}{ t \leq (t \cong t) } $$
*   **Rule F3:** $$ \frac{t_1 \cong t_2}{t_1 \leq (t_1 \cong t_2)} $$
*   **Rule F4:** $$ \frac{t_1 \cong t_2}{t_2 \leq (t_1 \cong t_2)} $$
### 模块 G: 全局结构推理

*   **Rule G1:**
    $$ \frac{\forall x. (t_1 \cong t_2)}{(\forall x. t_1) \cong (\forall x. t_2)} $$



### 模块 H: 格界限与量词序

*   **Rule H1:**
    $$ \frac{}{\forall x. t \leq \exists x. t} $$
    *(注：假设论域非空)*

*   **Rule H2:**
    若 $x$ 不在 $t$ 中自由出现 ($x \notin FV(t)$)：
    $$ \frac{}{\forall x. t \cong \exists x. t} $$

### 模块 I: 量词交换律

*   **Rule I1:**
    $$ \frac{}{\forall x. \forall y. t \cong \forall y. \forall x. t} $$
    $$ \frac{}{\exists x. \exists y. t \cong \exists y. \exists x. t} $$

*   **Rule I2:**
    $$ \frac{}{\exists x. \forall y. t \leq \forall y. \exists x. t} $$

### 模块 J: 结构分配律 (Structural Distributivity)

*   **Rule J1:**
    $$ \frac{}{\forall x. (t_1 \leq t_2) \leq (t_1 \leq \forall x. t_2)} $$

---

### 3.2 量词逻辑 (Quantifier Logic)
引入标准的自然演绎规则，但在应用时需注意 $t$ 的结构变化。

*   **Rule Q1 ($\forall$-Intro):**
    $$ \frac{\Gamma \vdash t}{\Gamma \vdash \forall x. t} $$
    *条件：* $x$ 不在 $\Gamma$ 的任何自由变量中出现。

*   **Rule Q2 ($\forall$-Elim):**
    $$ \frac{\forall x. t}{t[u/x]} $$
    *条件：* $u$ 是任意项，且对 $x$ 在 $t$ 中是自由的。

*   **Rule Q3 ($\exists$-Intro):**
    $$ \frac{t[u/x]}{\exists x. t} $$

*   **Rule Q4 ($\exists$-Elim):**
    $$ \frac{\Gamma, t[y/x] \vdash t' \quad \Gamma \vdash \exists x. t}{\Gamma \vdash t'} $$
    *条件：* $y$ 不在 $\Gamma, \exists x. t, t'$ 中自由出现。


---

## 4. 可靠性证明 (Soundness Proof)

**定义:** 若 $\Gamma \vdash t$ 蕴含 $\Gamma \vDash t$（即在任意符合前提的模型和赋值下，结论的解释真值均为 1），则称规则是可靠的。

### 4.0 基础引理

**引理 1 (结构不变量):**
对于任意结构值 $\mathbf{v}$：
1.  **Lift:** $\mathbf{v} \approx \text{lift}(\mathbf{v})$。
    *证明:* `lift` 仅改变 $k$，不改变 $i, \lambda, p$。定义 $\approx$ 仅依赖 $i, \lambda, p$，故成立。
2.  **Merge-Lift:** $\text{merge-lift}(\mathbf{v}_1, \mathbf{v}_2) \approx \mathbf{v}_2$。
    *证明:* `merge-lift` 显式继承 $\mathbf{v}_2$ 的 $i, \lambda, p$。

**引理 2 (同余代换):**
若 $\mathbf{v}_1 \approx \mathbf{v}_2$，则 $\forall \mathbf{v}_3$：
1.  $\mathbf{v}_1 \preceq \mathbf{v}_3 \iff \mathbf{v}_2 \preceq \mathbf{v}_3$。
2.  $\mathbf{v}_3 \preceq \mathbf{v}_1 \iff \mathbf{v}_3 \preceq \mathbf{v}_2$。
*证明:* $\preceq$ 的判定条件完全由 $\lambda, p$ 决定。由于 $\mathbf{v}_1 \approx \mathbf{v}_2$ 意味着这两个分量全等，故逻辑真值保持不变。

### 4.1 核心结构逻辑规则验证

#### 模块 A: 等价性质
*   **Rule A1 (Refl):** $t \cong t$.
    *验证:* 自反性显然。$\lambda = \lambda, p=p, i=i, k=k$。$\tau=1$。可靠。
*   **Rule A2 (Symm):** $t_1 \cong t_2 \vdash t_2 \cong t_1$.
    *验证:* 相等关系的对称性直接保证了 $i, \lambda, p, k, \tau$ 的对称性。可靠。
*   **Rule A3 (Trans):** $t_1 \cong t_2, t_2 \cong t_3 \vdash t_1 \cong t_3$.
    *验证:* 相等关系的传递性。若 $\lambda_1=\lambda_2$ 且 $\lambda_2=\lambda_3$，则 $\lambda_1=\lambda_3$。其他分量同理。可靠。

#### 模块 B: 序与同余
*   **Id-Intro:** $t \leq t$.
    *验证:* 需证 $\mathbf{v} \preceq \mathbf{v}$。
    若 $p=0$，需 $\lambda \sqsubseteq \lambda$；若 $p=1$，需 $\lambda \sqsupseteq \lambda$。由格偏序的自反性，均成立。可靠。
*   **Transitivity:** $t_1 \leq t_2, t_2 \leq t_3 \vdash t_1 \leq t_3$.
    *验证:* 前提蕴含 $p_1=p_2=p_3$。
    若 $p=0$: $\lambda_1 \sqsubseteq \lambda_2 \land \lambda_2 \sqsubseteq \lambda_3 \implies \lambda_1 \sqsubseteq \lambda_3$ (格偏序传递性)。
    若 $p=1$: $\lambda_1 \sqsupseteq \lambda_2 \land \lambda_2 \sqsupseteq \lambda_3 \implies \lambda_1 \sqsupseteq \lambda_3$。
    可靠。
*   **Cumulativity:** $t_1 \leq t_2 \vdash t_2 \leq (t_1 \leq t_2)$.
    *验证:* 设 $R = (t_1 \leq t_2)$。由定义，$\mathbf{v}_R = \text{merge-lift}(\mathbf{v}_1, \mathbf{v}_2) \approx \mathbf{v}_2$ (引理 1)。
    由 Id-Intro 知 $\mathbf{v}_2 \preceq \mathbf{v}_2$。由同余代换引理 (引理 2)，得 $\mathbf{v}_2 \preceq \mathbf{v}_R$。可靠。
*   **Rule B1:** $t_1 \leq t_2, t_2 \cong t_3 \vdash t_1 \leq (t_2 \cong t_3)$.
    *验证:* 设 $R = (t_2 \cong t_3)$，则 $\mathbf{v}_R = \text{lift}(\mathbf{v}_2) \approx \mathbf{v}_2$。
    前提已知 $\mathbf{v}_1 \preceq \mathbf{v}_2$。代换得 $\mathbf{v}_1 \preceq \mathbf{v}_R$。可靠。
*   **Rule B2:** $t_1 \leq t_2, t_1 \cong t_3 \vdash (t_1 \cong t_3) \leq t_2$.
    *验证:* 设 $L = (t_1 \cong t_3)$，则 $\mathbf{v}_L = \text{lift}(\mathbf{v}_1) \approx \mathbf{v}_1$。
    前提 $\mathbf{v}_1 \preceq \mathbf{v}_2 \implies \mathbf{v}_L \preceq \mathbf{v}_2$。可靠。
*   **Rule B3:** $(t_1 \cong t_2) \leq t_3,t_{1} \cong t_{2}, t_2 \cong t_4 \vdash (t_2 \cong t_4) \leq t_3$.
    *验证:* 设 $L_1 = (t_1 \cong t_2), L_2 = (t_2 \cong t_4)$。
    前提蕴含 $\mathbf{v}_1 \approx \mathbf{v}_2$ 且 $\mathbf{v}_2 \approx \mathbf{v}_4$。
    故 $\mathbf{v}_{L1} = \text{lift}(\mathbf{v}_1) \approx \text{lift}(\mathbf{v}_2) \approx \mathbf{v}_{L2}$。
    已知 $\mathbf{v}_{L1} \preceq \mathbf{v}_3$，代换得 $\mathbf{v}_{L2} \preceq \mathbf{v}_3$。可靠。
*   **Rule B4:** $t_1 \leq (t_2 \cong t_3),t_{2}\cong t_{3}, t_3 \cong t_4 \vdash t_1 \leq (t_3 \cong t_4)$.
    *验证:* 设 $R_1 = (t_2 \cong t_3), R_2 = (t_3 \cong t_4)$。
    前提蕴含 $\mathbf{v}_2 \approx \mathbf{v}_3$ 且 $\mathbf{v}_3 \approx \mathbf{v}_4$。
    故 $\mathbf{v}_{R1} = \text{lift}(\mathbf{v}_2) \approx \text{lift}(\mathbf{v}_3) \approx \mathbf{v}_{R2}$。
    已知 $\mathbf{v}_1 \preceq \mathbf{v}_{R1}$，代换得 $\mathbf{v}_1 \preceq \mathbf{v}_{R2}$。可靠。

#### 模块 C: 构造同余
*   **Rule C1:** $t_1 \cong t_2, t_3 \cong t_4 \vdash (t_1 \leq t_3) \cong (t_2 \leq t_4)$.
    *验证:* 设 $L = (t_1 \leq t_3), R = (t_2 \leq t_4)$。
    由前提，$\mathbf{v}_1 \approx \mathbf{v}_2$ 且 $\mathbf{v}_3 \approx \mathbf{v}_4$。
    1.  **结构近似:** $\mathbf{v}_L$ 继承 $\mathbf{v}_3$ 的 $(i, \lambda, p)$，$\mathbf{v}_R$ 继承 $\mathbf{v}_4$ 的 $(i, \lambda, p)$。因 $\mathbf{v}_3 \approx \mathbf{v}_4$，故 $\mathbf{v}_L \approx \mathbf{v}_R$。
	    1.  $LHS = (t_1 \leq t_3)$。根据 `merge-lift` 定义，其标识符 $i_L$ 继承自右操作数 $t_3$，即 $i_L = i_3$。
	    2.  $RHS = (t_2 \leq t_4)$。同理，$i_R = i_4$。
	    3.  前提 $t_3 \cong t_4$ 蕴含 $\mathbf{v}_3 \approx \mathbf{v}_4$，从而必然有 $i_3 = i_4$。
	    4.  因此 $i_L = i_R$。
    2.  **真值一致:** $\tau_L = 1 \iff \mathbf{v}_1 \preceq \mathbf{v}_3$。$\tau_R = 1 \iff \mathbf{v}_2 \preceq \mathbf{v}_4$。由同余代换引理，二者等价。
    3.  **索引:** $k_L = \max(k_1, k_3)+1 = \max(k_2, k_4)+1 = k_R$。
    可靠。
*   **Rule C2:** $t_1 \cong t_2 \vdash \neg t_1 \cong \neg t_2$.
    *验证:* $\mathbf{v}(\neg t)$ 仅翻转 $p$，保留 $\lambda, i, k$。若 $\mathbf{v}_1 \approx \mathbf{v}_2$，则 $p_1=p_2 \implies 1-p_1=1-p_2$，其他分量亦相等。故 $\mathbf{v}(\neg t_1) \approx \mathbf{v}(\neg t_2)$。真值亦一致。可靠。
*   **Rule C3:** $t_1 \cong t_2 \vdash \forall x. t_1 \cong \forall x. t_2$.
    *验证:*
    设 $\mathbf{v}_1, \mathbf{v}_2$ 为 $t_1, t_2$ 在任意赋值下的结构值。前提蕴含 $\mathbf{v}_1$ 与 $\mathbf{v}_2$ 在所有分量 $(i, \lambda, k, p)$ 上全等。
    考察结论 $\forall x. t_1$ 与 $\forall x. t_2$ 的结构值：
    1.  **标识符:** 均为 $0$ (由 `quant-agg` 强制归零)。相等。
    2.  **极性:** 均为 $0$。相等。
    3.  **构造索引:** $k_{new} = \sup_{d \in \mathcal{D}}(k(t[d/x])) + 1$。因内部 $k$ 值逐点相等，故上确界相等。
	4.  **格位:** $\lambda_{new} = \sqcap_{d \in \mathcal{D}} \lambda(t[d/x])$。因内部 $\lambda$ 逐点相等，故下确界相等。
    结论：所有分量全等，真值为 1。**可靠。**

#### 模块 D: 否定逻辑
*   **Rule D0:** $\neg t_2 \leq \neg t_1 \vdash t_1 \leq t_2$.
    *验证:*
    前提 $\implies \mathbf{v}_{\neg t_2} \preceq \mathbf{v}_{\neg t_1}$。这蕴含 $i_1=i_2$ 且 $p(\neg t_2) = p(\neg t_1)$，进而推得 $p(t_1) = p(t_2)$。
    设原始极性为 $p$。
    *   **情形 1 ($p=0$, 正极性):**
        前提中的 $\neg t$ 极性为 1 (负)。
        负极性下的序定义为逆变：$\lambda(\neg t_2) \sqsupseteq \lambda(\neg t_1)$。
        即 $\lambda_2 \sqsupseteq \lambda_1$。
        结论需证 $t_1 \leq t_2$ (正极性)，这要求 $\lambda_1 \sqsubseteq \lambda_2$。
        上述两式等价。
    *   **情形 2 ($p=1$, 负极性):**
        前提中的 $\neg t$ 极性为 0 (正)。
        正极性序定义为协变：$\lambda(\neg t_2) \sqsubseteq \lambda(\neg t_1)$。
        即 $\lambda_2 \sqsubseteq \lambda_1$。
        结论需证 $t_1 \leq t_2$ (负极性)，这要求 $\lambda_1 \sqsupseteq \lambda_2$。
        上述两式等价。
    **可靠。**
*   **Rule D1:** $t_1 \leq t_2 \vdash \neg t_2 \leq \neg t_1$.
    *验证:* 前提 $\implies \mathbf{v}_1 \preceq \mathbf{v}_2$。隐含 $p_1=p_2$。
    *   **情况 1 ($p=0$):** 前提意味着 $\lambda_1 \sqsubseteq \lambda_2$。
        结论需验证 $\mathbf{v}_{\neg t_2} \preceq \mathbf{v}_{\neg t_1}$。此时极性均为 $1-0=1$ (负)。
        负极性下的序定义要求：$\lambda_{\text{left}} \sqsupseteq \lambda_{\text{right}}$，即 $\lambda_2 \sqsupseteq \lambda_1$。
        这与 $\lambda_1 \sqsubseteq \lambda_2$ 等价。成立。
    *   **情况 2 ($p=1$):** 前提意味着 $\lambda_1 \sqsupseteq \lambda_2$。
        结论极性均为 $0$ (正)。正极性序定义要求 $\lambda_2 \sqsubseteq \lambda_1$。等价。成立。
    可靠。
*   **Rule D2:** $\vdash t \leq \neg \neg t$.
    *验证:* $\mathbf{v}(\neg \neg t)$ 经过两次极性翻转回归原值，结构完全等同于 $\mathbf{v}(t)$。由 Id-Intro 可证。可靠。
*   **Rule D3:** $\vdash \neg (t \cong \neg t)$.
    *验证:* $t \cong \neg t$ 要求 $\mathbf{v}(t) \approx \mathbf{v}(\neg t)$。但这要求 $p = 1-p$，在 $\{0,1\}$ 中无解。故内部真值为 0，否定后为 1。可靠。
*   **Rule D5:** $\vdash \neg \neg t \cong t$.
    *验证:* 同 D2，两次翻转后各项分量完全复原，满足全等条件。可靠。
*   **Rule D6:** $t, \neg t \vdash t_2$.
    *验证:* 前提要求 $\tau(t)=1$ 且 $1-\tau(t)=1$，即 $1=0$。前提矛盾，规则真空成立。可靠。

#### 模块 E: 替换规则
*   **Rule E1:** $t_1 \cong t_2, t_1 \leq t_3 \vdash t_2 \leq t_3$.
    *验证:* $\mathbf{v}_1 \approx \mathbf{v}_2$。由引理 2，$\mathbf{v}_1 \preceq \mathbf{v}_3 \implies \mathbf{v}_2 \preceq \mathbf{v}_3$。可靠。
*   **Rule E2:** $t_3 \leq t_1, t_1 \cong t_2 \vdash t_3 \leq t_2$.
    *验证:* 同上，右侧代换成立。可靠。
*   **Rule E3:** $t_1 \cong t_2, \neg t_1 \vdash \neg t_2$.
    *验证:* $t_1 \cong t_2 \implies \tau(t_1) = \tau(t_2)$。$\tau(\neg t_1)=1 \implies \tau(t_1)=0 \implies \tau(t_2)=0 \implies \tau(\neg t_2)=1$。可靠。
*   **Rule E4:** $t_1, t_1 \cong t_2 \vdash t_2$.
    *验证:* $\tau(t_1)=1 \land \tau(t_1)=\tau(t_2) \implies \tau(t_2)=1$。可靠。

#### 模块 F: 层级规则
*   **Rule F1:** $\vdash t \leq (t \cong t)$.
    *验证:* 右项结构为 $\text{lift}(\mathbf{v}_t) \approx \mathbf{v}_t$。由自反性 $t \leq t$ 及同余代换可得。可靠。
*   **Rule F3:** $t_1 \cong t_2 \vdash t_1 \leq (t_1 \cong t_2)$.
    *验证:* 右项结构 $\text{lift}(\mathbf{v}_1) \approx \mathbf{v}_1$。即证 $\mathbf{v}_1 \preceq \mathbf{v}_1$。成立。
*   **Rule F4:** $t_1 \cong t_2 \vdash t_2 \leq (t_1 \cong t_2)$.
    *验证:* 右项结构 $\text{lift}(\mathbf{v}_1) \approx \mathbf{v}_1$。前提 $\mathbf{v}_1 \approx \mathbf{v}_2$。
    故右项 $\approx \mathbf{v}_2$。即证 $\mathbf{v}_2 \preceq \mathbf{v}_2$。成立。

#### 模块 G: 全局规则
*   **Rule G1:** $\forall x. (t_1 \cong t_2) \vdash (\forall x. t_1) \cong (\forall x. t_2)$.
    *验证:*
    前提 $\forall x. (t_1 \cong t_2)$ 的真值为 1，意味着对论域中任意 $d \in \mathcal{D}$，解释 $⟦ t_1 \cong t_2 ⟧_{g[x \mapsto d]}$ 的真值均为 1。
    根据 $\cong$ 的语义定义，这意味着对于所有 $d$：
    $$ i_1(d) = i_2(d), \quad \lambda_1(d) = \lambda_2(d), \quad p_1(d) = p_2(d), \quad k_1(d) = k_2(d) $$
    现在考察结论的两侧：
    1.  **标识符与极性：** 量化后均为 $0$ 和 $0$，自然相等。
	2.  **格位：** 左侧 $\lambda_L = \sqcap_d \lambda_1(d)$，右侧 $\lambda_R = \sqcap_d \lambda_2(d)$。由于 $\forall d, \lambda_1(d) = \lambda_2(d)$，由集合论外延性公理，其集合相同，故下确界相等。
    3.  **构造索引：** 同理，$\sup_d k_1(d) = \sup_d k_2(d)$。
    因此，左右两侧结构值完全全等。**可靠。**
### 4.2 量词逻辑验证

*   **Rule Q1 ($\forall$-Intro):** $\Gamma \vdash t \implies \Gamma \vdash \forall x. t$ ($x \notin FV(\Gamma)$)。
    *验证:* 假设 $\Gamma$ 在赋值 $g$ 下为真。对任意 $d \in \mathcal{D}$，因 $x$ 不在 $\Gamma$ 中，$g[x \mapsto d]$ 仍使 $\Gamma$ 为真。由前提 $\Gamma \vdash t$，可知 $t$ 在所有这些赋值下均为真。
    因此 $T_{set}$ 全为 1，$\min(T_{set}) = 1$。故 $\forall x. t$ 真值为 1。可靠。

*   **Rule Q2 ($\forall$-Elim):** $\forall x. t \vdash t[u/x]$.
    *验证:* 若 $\forall x. t$ 为真，则对任意 $d \in \mathcal{D}$，$t$ 在 $x \mapsto d$ 下为真。
    $t[u/x]$ 的解释等同于 $t$ 在 $x \mapsto ⟦u⟧_g$ 下的解释。
    因 $⟦u⟧_g \in \mathcal{D}$，故 $t[u/x]$ 必为真。可靠。

*   **Rule Q3 ($\exists$-Intro):** $t[u/x] \vdash \exists x. t$.
    *验证:* 若 $t[u/x]$ 为真，则存在 $d = ⟦u⟧_g$ 使得 $t$ 在 $x \mapsto d$ 下为真。
    $\exists x. t$ 的真值为 $\max(T_{set})$。因集合包含 1，故最大值为 1。可靠。

*   **Rule Q4 ($\exists$-Elim):** $\Gamma, t[y/x] \vdash t', \Gamma \vdash \exists x. t \implies \Gamma \vdash t'$.
    *验证:* 设 $\Gamma$ 为真。由 $\exists x. t$ 为真，存在 $d^* \in \mathcal{D}$ 使 $t$ 在 $x \mapsto d^*$ 下为真。
    构造赋值 $g' = g[y \mapsto d^*]$。在此赋值下 $\Gamma$ 为真（$y$ 不在 $\Gamma$），且 $t[y/x]$ 为真。
    由前提 1，推得 $t'$ 在 $g'$ 下为真。
    因 $y$ 不在 $t'$ 中，故 $t'$ 在原赋值 $g$ 下亦为真。可靠。

*   **Rule H1:** $\vdash \forall x. t \leq \exists x. t$
	*   **语义分析:**
	    *   **LHS ($\forall x. t$):** $i=0, p=0, \lambda_L = \sqcap_{d \in \mathcal{D}} \lambda(t_d), k_L = \sup k(t_d) + 1$。
	    *   **RHS ($\exists x. t$):** $i=0, p=0, \lambda_R = \bigsqcup_{d \in \mathcal{D}} \lambda(t_d), k_R = \sup k(t_d) + 1$。
	*   **序关系判定 ($\preceq$):**
	    1.  **极性:** $p_L = p_R = 0$ (一致)。
	    2.  **结构序:** 需验证 $\lambda_L \sqsubseteq \lambda_R$（正极性协变）。
	        由格论性质，对于非空集合 $S = \{ \lambda(t_d) \mid d \in \mathcal{D} \}$，必有 $\sqcap S \sqsubseteq \bigsqcup S$。
	*    **论域非空。**
	*   **结论:** 规则可靠。

*   **Rule H2:** $x \notin FV(t) \vdash \forall x. t \cong \exists x. t$
	*   **语义分析:**
	    若 $x$ 不自由出现，则对于所有 $d \in \mathcal{D}$，$t[d/x]$ 的解释值恒定为 $\mathbf{v}_0$。
	    *   集合 $S = \{ \mathbf{v}_0 \}$ 是单元素集。
	    *   $\lambda(\forall) = \sqcap \{ \lambda_0 \} = \lambda_0$。
	    *   $\lambda(\exists) = \bigsqcup \{ \lambda_0 \} = \lambda_0$。
	    *   $k(\forall) = k(\exists) = k_0 + 1$。
	    *   $i, p$ 均强制重置为 0。
	*   **结构等价 ($\approx$):** 所有分量完全相等。
	*   **论域非空。**
	*   **结论:** 规则可靠。

*   **Rule I1:** $\vdash \forall x. \forall y. t \cong \forall y. \forall x. t$
	*   **语义分析:**
	    *   **LHS:** 对格位取两次下确界 $\lambda_L = \sqcap_{d_x} (\sqcap_{d_y} \lambda_{xy}) = \sqcap_{d_x, d_y} \lambda_{xy}$。
	    *   **RHS:** 对格位取两次下确界 $\lambda_R = \sqcap_{d_y} (\sqcap_{d_x} \lambda_{xy}) = \sqcap_{d_x, d_y} \lambda_{xy}$。
	    *   格运算 $\sqcap$ 满足交换律和结合律，故 $\lambda_L = \lambda_R$。
	    *   $k$ 值均为 $\sup(\sup k + 1) + 1 = \sup k + 2$。
	    *   $i, p$ 均为 0。
	*   **结论:** 规则可靠。（存在量词同理，利用 $\bigsqcup$ 的交换结合律）。

*   **Rule I2:** $\vdash \exists x. \forall y. t \leq \forall y. \exists x. t$
	*   **语义分析:**
	    *   **LHS ($\exists x \forall y$):** $\lambda_L = \bigsqcup_x \left( \sqcap_y \lambda_{xy} \right)$。$p=0$。
	    *   **RHS ($\forall y \exists x$):** $\lambda_R = \sqcap_y \left( \bigsqcup_x \lambda_{xy} \right)$。$p=0$。
	*   **格论不等式:**
	    在任意完备格中，"先取下确界再取上确界" 的值 永远小于等于 "先取上确界再取下确界"。
	    即：$\bigsqcup_x \sqcap_y \lambda_{xy} \sqsubseteq \sqcap_y \bigsqcup_x \lambda_{xy}$。
	*   **序关系判定:** $p=0$ 且 $\lambda_L \sqsubseteq \lambda_R$，故成立。
	*   **结论:** 规则可靠。

*   **Rule J1:**
*   **目标:** $\vdash\forall x. (t_1 \leq t_2) \leq (t_1 \leq \forall x. t_2)$
*   **项解析:**
    *   $A = \forall x. (t_1 \leq t_2)$。语义：$\lambda_A = \sqcap_x \lambda(t_1 \leq t_2[x])$。
        注意：$(t_1 \leq t_2)$ 的解释真值为 1 当且仅当 $\mathbf{v}_1 \preceq \mathbf{v}_2(x)$。此时其结构值为 $\text{merge-lift}(\mathbf{v}_1, \mathbf{v}_2(x))$，格位继承自 $\mathbf{v}_2(x)$。
        所以 $\lambda_A = \sqcap_x \lambda_2(x)$。
    *   $B = (t_1 \leq \forall x. t_2)$。语义：$\mathbf{v}_B$ 的格位继承自右侧 $\forall x. t_2$，即 $\lambda_B = \sqcap_x \lambda_2(x)$。
*   **比较:**
    *   $\lambda_A = \lambda_B$。
    *   $k_A = \sup_x (\max(k_1, k_2(x)) + 1) + 1$。
    *   $k_B = \max(k_1, \sup_x k_2(x) + 1) + 1$。
    *   通常 $k$ 值在层级逻辑中不影响 $\leq$ 的判定（$\preceq$ 忽略 $k$），只影响 $\cong$。
    *   判定 $A \leq B$：
        *   两者均为不等式项，若真值为1，则 $p=0$。
        *   $\lambda_A = \lambda_B \implies \lambda_A \sqsubseteq \lambda_B$。
*   **结论:** 规则可靠。


